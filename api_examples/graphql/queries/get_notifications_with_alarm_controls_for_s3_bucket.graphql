# Description
# -----------
#
#
# The query returns the data from activity log.
# Filters out the control on a s3 bucket that moved from any state to ALARM within last 24 hours.
# 
#

# Usage
# -----
#
# turbot graphql --query ./get_notifications_with_alarm_controls_for_s3_bucket.graphql
#

# Filter
# ------
#
# notificationType:
#   Filter on the general type of notifications.
#   This will filter all create, update, and delete notifications of a given class. 
#   In example, this is set to `notificationType:control_updated`.
#
# resourceType:
#   Filter resources of a specific resource type.
#   In example, the resources 'tmod:@turbot/aws-s3#/resource/types/bucket' are returned.
#
# timestamp:
#   The time when resource was last created or updated.
#   In this example, it is set for last 24 hours.

# Documentation
# -------------
#
# For full documentation see:
# - Filter documentation: https://turbot.com/v5/docs/reference/filter
# - GraphQL notifications: https://turbot.com/v5/docs/reference/filter/notifications
# - GraphQL notifications type: https://turbot.com/v5/docs/concepts/notifications#notification-types
#

query GetNotificationsWithAlarmControlsForS3Bucket {
  notifications(filter: "notificationType:control_updated resourceType:'tmod:@turbot/aws-s3#/resource/types/bucket' timestamp:>T-1d level:self") {
    metadata {
      stats {
        total
      }
    }
    items {
      notificationType
      resource {
        trunk {
          title
        }
        controls(filter: "state:alarm") {
          items {
            state
            reason
          }
        }
      }
    }
  }
}