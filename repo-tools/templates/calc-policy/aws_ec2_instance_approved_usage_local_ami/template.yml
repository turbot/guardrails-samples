title: AWS EC2 Instance - restrict instance image to local AMI
useCase: |
  Use this policy if you would like to restrict the usage of EC2 instance images to local account AMI images only.
details: |
  Calculated policy for policy `AWS > EC2 > Instance > Approved > Usage`.
  If a EC2 instance image is not owned by the account that the instance is running in, then the approved usage
  policy will be set to `Not approved` otherwise it will be set to `Approved`.
templateInput:
  details: |
    GraphQL query that will check if a Instance has accounts with restore access.
    If the query returns an array of zero items, then the instance image is not a local AMI.
  query: |
    - {
      item: resource {
        imageId: get(path: "ImageId")
        turbot {
          custom
        }
      }
    }
    - {
      resources (filter: "resourceType:'tmod:@turbot/aws-ec2#/resource/types/Ami' $.ImageId:'{{$.item.imageId}}' $.OwnerId:'{{$.item.turbot.custom.aws.accountId}}'") {
        metadata {
          stats {
            total
          }
        }
      }
    }
template:
  details: |
    Approval logic for EC2 instance image local AMI.
  source: |
    {% if $.resources.metadata.stats.total %}
      Approved
    {% else %}
      Not approved
    {% endif %}
