title: AWS RDS DB Cluster - Restrict Cross Account Snapshots by user defined Whitelist
useCase: |
  Cluster Snapshot set to `Not approved` if cross account access exists to an account not in a whitelist.
details: |
  Use the AWS > RDS > DB Cluster Snapshot [Manual] > Approved > Usage policy.
  Calculated policy for policy `AWS > RDS > DB Cluster Snapshot [Manual] > Approved > Usage` policy.
  If the account that the snapshot is shared with, given by the property ``
templateInput:
  details: |
    GraphQL query that will return all the shared account details to compare against a whitelist to ensure that the
    snapshot is valid.
  query: |
    {
      dbClusterSnapshotManual 
      {
        sharedAccounts: get(path:"DBClusterSnapshotAttributes.AttributeValues")
      }
    }
template:
  details: |
    Add items to the currently empty `whitelist` collection as detailed in inline example comments.
    The Nunjucks script will then check if all the accounts that are shared with the snapshot are valid by comparing 
    entries from a whitelist of accounts.

    **Note:** All the accounts that are being shared by the snapshot need to have an entry in the whitelist in order
    for the snapshot to be valid, otherwise it will be invalid and set to `Not approved`.
  source: |
    {#- Whitelist of account that are approved for snapshot usage -#}
    {#- To add an item to the whitelist, add an entry to the whitelist array -#}
    {#- set whitelist = ["1111111111111", "2222222222222"] -#}
    {#- Initially the whitelist is set to empty -#}
    {%- set whitelist = [] -%}
    {%- set approvalCount = 0 -%}

    {%- for sharedAccount in $.dbClusterSnapshotManual.sharedAccounts | sort -%}
      {%- for validAccount in whitelist | sort -%}
        {%- if validAccount == sharedAccount -%}
          {%- set approvalCount = approvalCount + 1 -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endfor -%}

    {%- if approvalCount ==  $.dbClusterSnapshotManual.sharedAccounts | length -%}
      "Approved"
    {%- else -%}
      "Not approved"
    {%- endif -%}
